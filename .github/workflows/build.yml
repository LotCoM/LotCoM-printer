name: CI

on:
  push:
  pull_request:
    branches: [ main ]
    paths:
    - '**.cs'
    - '**.csproj'

env:
  DOTNET_VERSION: '9.0.103' # The .NET SDK version to use
  DOTNET_INSTALL_DIR: '.\.dotnet'

jobs:

  cache-dotnet:
    name: cache_dotnet
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]
    
    steps:
    - name: Cache dotnet
      id: cache-dotnet
      uses: actions/cache@v3
      with:
        path: ${{ env.DOTNET_INSTALL_DIR }}
        key: ${{ runner.os }}-dotnet-${{env.DOTNET_VERSION}}
        restore-keys: ${{ runner.os }}-dotnet-${{env.DOTNET_VERSION}}

    - name: Install dotnet
      if: ${{ steps.cache-dotnet.outputs.cache-hit != 'true' }}
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{env.DOTNET_VERSION}}

    - name: Check default dotnet version
      run: dotnet --version

    - name: Set installed/cached dotnet path [${{ env.DOTNET_INSTALL_DIR }}]
      run: echo "${{ env.DOTNET_INSTALL_DIR }}" | Out-File -FilePath $ENV:GITHUB_PATH -Encoding utf8 -Append

    - name: Check installed/cached dotnet version
      run: dotnet --version

  build:

    name: build-${{matrix.os}}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]

    steps:
    # - uses: actions/checkout@v3
    # - name: Setup .NET Core
    #   uses: actions/setup-dotnet@v3
    #   with:
    #     dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Install MAUI 
      run: ${{env.DOTNET_INSTALL_DIR}}\dotnet workload install maui
      
    - name: Install dependencies
      run: ${{env.DOTNET_INSTALL_DIR}}\dotnet restore
      
    - name: Build
      run: ${{env.DOTNET_INSTALL_DIR}}\dotnet build

    - name: Archive build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: latest-${{matrix.os}}-build
        path: |
          D:\a\LotCoM-printer\LotCoM-printer\LotCoMPrinter\bin\Debug\net9.0-windows*

  package:
    
    name: package-msix
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]

    steps:
    # - uses: actions/checkout@v3
    # - name: Setup .NET Core
    #   uses: actions/setup-dotnet@v3
    #   with:
    #     dotnet-version: ${{ env.DOTNET_VERSION }}
      
    - name: Package
      run: ${{env.DOTNET_INSTALL_DIR}}\dotnet publish -f net9.0-windows10.0.19041.0 -c Release -p:RuntimeIdentifierOverride=win10-x64 -p:WindowsPackageType=MSIX -p:WindowsAppSDKSelfContained=true

    - name: Archive package artifact
      uses: actions/upload-artifact@v4
      with:
        name: latest-${{matrix.os}}-package
        path: |
          D:\a\LotCoM-printer\LotCoM-printer\LotCoMPrinter\bin\Release\net9.0-windows10.0.19041.0\win10-x64\AppPackages\**\*.msix
          
  sign:

    name: sign-msix
    needs: package
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]

    steps:
    - name: Download MSIX package
      uses: actions/download-artifact@v4
      with:
        name: latest-${{matrix.os}}-package
        
        
    - name: Sign MSIX with Certificate
      shell: pwsh
      run: |
        # Decode the Base64 Certificate
        $certificateBase64 = ${{secrets.SIGNING_CERTIFICATE_BASE64}}
        $certificateData = [System.Convert]::FromBase64String($certificateBase64)
        $certificate = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2($certificateData)
        $password = ${{secrets.SIGNING_CERTIFICATE_PASSWORD}}  
        $certificate.Export(".\signing-certificate.pfx", "Pfx", $password)

        # Save the directory of the MSIX file
        $msix = D:\a\LotCoM-printer\LotCoM-printer\LotCoMPrinter\bin\Release\net9.0-windows10.0.19041.0\win10-x64\AppPackages\**\*.msix

        # Sign the MSIX Package using SignTools
        cd "C:\Program Files (x86)\Windows Kits\10\bin\10*\x86"
        .\signtool.exe sign /fd SHA256 /a /f .\signing-certificate.pfx /t "http://timestamp.digicert.com" /p $password $msix

    - name: Archive signed MSIX artifact
      uses: actions/upload-artifact@v4
      with:
        name: latest-${{matrix.os}}-signed
        path: |
          D:\a\LotCoM-printer\LotCoM-printer\LotCoMPrinter\bin\Release\net9.0-windows10.0.19041.0\win10-x64\AppPackages\**\*.msix
